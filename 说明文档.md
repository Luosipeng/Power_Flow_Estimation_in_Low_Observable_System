# 低可观测条件下的潮流估算与拓扑识别开发手册

本手册面向使用本项目进行“低可观测电力配网的潮流估算与拓扑识别”的开发者，基于提供的代码文件，系统梳理了两大关键阶段的完整流程、数据结构、核心算法与工程注意事项，帮助快速理解与复现实验：

- Stage 1：多任务高斯过程（Multi-task GP）融合多源传感器数据、统一到分钟级时间轴、输出每个传感器的预测均值与不确定性。
- Stage 2：在低可观测条件下构建观测矩阵与噪声精度，进行矩阵分解与物理约束融合的潮流估算，并在备选拓扑集合上进行结构推断与识别。

手册引用的主要文件：
- Stage1_test.jl / implement_data.jl / multi_task_gaussian.jl / gaussian_prediction.jl / build_complete_multisensor_data.jl / data_processing.jl / extract_requested_dataset_multibatch.jl
- Stage2_test.jl / Stage2_full_test_opt.jl / build_observed_matrix_z.jl / build_noise_precision_beta.jl / get_topology.jl / power_flow_optimal.jl / lindistflow.jl / matrix_completion.jl
- 以及数据读取/辅助文件：read_mat.jl, generate_series_data.jl, compute_sensor_correlation_matrix.jl, compute_structure_posteriot.jl 等

## 问题描述
在交直流混合配电系统中，传感器数据存在多重难点：采样时间尺度不一致、数据缺失/遗漏严重、传感器覆盖率不足导致关键量测不可观。同时，系统的拓扑结构与线路参数（型号、阻抗等）未知或不完整，进一步加大了潮流计算与状态感知的难度。为了解决上述问题，提出一种“多任务高斯过程（MTGP）+ 贝叶斯稀疏矩阵填充”的联合建模框架，通过贝叶斯稀疏矩阵过程实现传感器数据的遗漏补齐，并添加概率信息，增强可信度；使用多任务高斯过程对无法观察到的系统信息进行补齐，并估计正确的拓扑结构。实现了交直流混合配电系统的潮流估算与拓扑组合估计。

--------------------------------
## 总览：两阶段的目标与接口

- Stage 1（数据同化与时序建模）
  - 输入：多批次原始传感器数据（PMU/SCADA/AMI），包含不齐时间采样与缺失。
  - 核心：基于ICM（Intrinsic Coregionalization Model）构造多任务GP，分解跨任务相关性与时间核，统一输出分钟级的全天预测轨迹与不确定性。
  - 输出：unified_predictions（传感器名 -> 预测均值/标准差/置信区间/原采样率等元数据），以及质量评估指标（RMSE/MAE/MAPE/R2/置信区间覆盖率）。

- Stage 2（潮流估算与拓扑识别）
  - 输入：Stage 1 的统一预测作为“观测源”，选定监测母线集合；系统的候选拓扑集合（或先验）。
  - 核心：构建观测矩阵 Z 与噪声精度矩阵 β；对 Z 做低秩矩阵分解（概率矩阵补全）并与潮流物理（AC/线性潮流）耦合优化；在备选拓扑上计算证据（ELBO或目标），通过温度化后验进行结构选择。
  - 输出：潮流注入/支路潮流/电压估计，最可能拓扑与其后验概率分布，及收敛与残差历史。

--------------------------------
## 数据与对象说明

- MultiSensorData（build_complete_multisensor_data.jl）
  - 字段：S（传感器数）、times::Vector{Vector{Float32}}、values::Vector{Vector{Float32}}、sensor_names、sensor_types
  - 传感器类型示例：:Vmag, :V_real, :V_imag, :P_kW, :Q_kVAR 等
- Stage 1 结果 result 典型字段：
  - result.data：MultiSensorData
  - result.norm_params：标准化参数
  - result.joint_pack：多任务联合训练包（拼接后的 x_all/y_all）
  - result.L_params / log_σ_time / log_ℓ_time / log_σ_locals / log_ℓ_locals / log_σ_noise 等超参数
- unified_predictions（implement_data.jl -> generate_1min_resolution_predictions）
  - time_hours/time_minutes/num_timepoints/sensors 字典
  - sensors[name] 包含：prediction_mean/std/ci_lower/ci_upper/measurement_times/measurement_values/original_sampling_rate/num_measurements/num_predictions
- Stage 2 的核心输入 daily_predictions
  - 即 unified_predictions，作为 build_observed_matrix_Z 与 build_noise_precision_beta 的数据源

--------------------------------
## Stage 1：多任务高斯过程（Full Sensor）流程与原理

本阶段入口：Stage1_test.jl

### 1. 数据读取与抽取
- read_mat()：读取多批次数据（batch_data_1 … batch_data_18）
- extract_requested_dataset_multibatch.jl：根据配置选择 PMU/SCADA/AMI 的目标母线，按任务拼接出目标数据集
- build_complete_multisensor_data.jl：构造包含所有传感器的 MultiSensorData
  - 示例中定义了 pmu_sensors、scada_sensors、ami_sensors；可以按需要扩展

注意：
- 数据中各传感器采样频率不一致、时间戳各自独立，后续需统一时间轴。

### 2. 数据预处理与归一化
- data_processing.jl：normalize_multisensor_data(data)
  - 计算时间与观测值的均值/方差，记录 NormalizationParams
  - 标准化后提升数值稳定性，便于核矩阵分解与优化

### 3. 多任务GP建模与训练
- multi_task_gaussian.jl
  - 核心思想：ICM结构
  - 任务相关性矩阵 B = L L'（L 为下三角参数矩阵 L_params）
  - 时间核 rbf_kernel(t1, t2, σ_time, ℓ_time)
  - 每个任务还包含本地核（σ_locals[s], ℓ_locals[s]），以及任务噪声 σ_noise[s]
  - 联合核：K((s,x),(t,x')) = B_st k_time(x,x') + δ_st k_local_s(x,x') + δ_st σ_noise[s]^2 I
  - construct_joint_K_all 构建全体训练点的联合核矩阵，并加入 jitter 保证 Cholesky 稳定

- 训练输出（通常包含在 result 对象中）
  - L_params（相关性参数）、log_σ_time、log_ℓ_time、log_σ_locals、log_ℓ_locals、log_σ_noise 等
  - joint_pack：拼接后的所有任务训练数据（时间向量 x_all、观测 y_all）
  - norm_params：归一化参数，用于预测时反归一化

工程要点：
- 大规模联合核矩阵可能很大，需关注内存；必要时采用子采样、分块或稀疏近似。
- jitter（如 1e-6 ~ 1e-4）对数值稳定至关重要。

### 4. 预测与统一时间轴
- implement_data.jl -> generate_1min_resolution_predictions(result)
  - 构造统一时间轴 t_unified：1 min 分辨率，覆盖所有传感器时间范围
  - 对每个传感器 s 调用 multitask_gp_predict(result, s, t_unified) 计算 μ_pred/σ_pred
  - 保存：均值、标准差、95%置信区间、原采样率估计、测量与预测点数量
  - 回到原测点还可评估 RMSE/MAE/MAPE/R2/置信区间覆盖率

- gaussian_prediction.jl
  - icm_predict(result, s, x_test)：在归一化空间预测，最后反归一化
  - 注重：对齐 result.data.sensor_names 与 s 的索引

产出：
- unified_predictions：后续 Stage 2 的关键输入 daily_predictions

--------------------------------
## Stage 2：潮流估算与拓扑识别流程与原理

本阶段入口：Stage2_test.jl 或 Stage2_full_test_opt.jl

Stage 2 的思想：将 Stage 1 的统一预测当作“观测候选”（不同物理量映射到观测矩阵 Z 的行列），构造噪声精度矩阵 β，实现：
- 概率矩阵补全（低秩分解 + 变分推断）重构系统状态矩阵 X ≈ A B'；
- 将重构状态与潮流物理（AC或线性分布式潮流）耦合，求电压、潮流与注入；
- 在备选拓扑上计算目标（如 ELBO 或优化目标值），通过结构后验选择最可能拓扑。

### 1. 读入拓扑、生成候选拓扑集（可选）
- read_topology_mat / get_topology.jl
  - default_topologies() 定义了 8 组开断边集合（候选结构）
  - generate_branch_list_with_prior(...) 可依据未知边集合与先验概率，生成拓扑假设列表与先验
  - same_edge / find_branch_indices 等工具用于匹配并行线、映射边集到支路矩阵

工程建议：
- 若有历史/运检信息，可为每个拓扑分配先验 prob_list。
- 可在 Stage 2 内部循环拓扑，对每个拓扑独立评估并排序。

### 2. 从 Stage 1 结果构建观测矩阵与噪声精度
- build_observed_matrix_z.jl
  - 基于 daily_predictions["sensors"] 字典与 column_map
  - 构建尺寸为 [num_nodes × num_cols] 的观测矩阵 Z
  - num_cols 典型约定：如 p/pb（有功注入/支路有功）、q/qb（无功）、v（电压幅值或实虚部）
  - monitor_buses::Set{Int} 控制仅对选定母线填入观测，其他为 0 或缺失
  - 返回：observed_matrix_Z、observed_pairs（哪些元素被观测）、monitored_obs（元数据）

- build_noise_precision_beta.jl
  - 根据每个观测对应的预测不确定性 σ_pred，构建 β = 1/σ^2
  - 对未观测位置 β = 0（或极小），仅对 observed_pairs 位置赋正值
  - 支持不同类型/列的 β 映射与缩放（可配置，文件内有 column_map 雏形）

注意：
- 需保证 daily_predictions 中的传感器名称与母线编号映射一致，否则会出现空观测。
- 观测矩阵的列定义需与后续物理模型一致（例如与 power_flow_optimal 的注入/电压变量一致）。

### 3. 低秩矩阵分解与概率矩阵补全
- Stage2_test.jl 和 Stage2_full_test_opt.jl 中共有的初始化策略：
  - 对 observed_matrix_Z 做 SVD，取前 r 个奇异值/向量，初始化 A_mean, B_mean
  - 典型 r 取 5 或由矩阵尺寸 min(5, min(m,n)) 限制
- 变分参数
  - A_mean ∈ R^{m×r}, B_mean ∈ R^{n×r}
  - Σa_list, Σb_list：对每行/每列潜在因子的协方差
  - γ：AR D 中的超先验（行列稀疏或尺度控制）
- matrix_completion.jl 核心函数片段：
  - fraction_available_data(Z)：可用观测比例
  - cal_beta_BTB_i / cal_sigma_a_i / …：逐行/逐列更新变分后验的计算模板
  - 目标：在 β 加权的观测误差与先验正则之间求平衡，逐步更新 A, B, Σa, Σb, γ
- 收敛控制
  - tolerance、max_iter、c、d 等作为步长/正则/收敛门限
  - 监控 rel_change 等历史指标

直觉解释：
- 低秩假设对应状态矩阵的时空相关性或跨量测的耦合结构；
- β 将 Stage 1 的不确定性引入为“可信度权重”，不确定性越大权重越低。

### 4. 潮流物理约束与优化
两种可选建模：

- AC 潮流 + 优化（power_flow_optimal.jl）
  - build_ybus(branch, n)：构建节点导纳矩阵 Y
  - ac_nodal_injection(P_inj, Q_inj, Vb, branch, root_bus, Vref, θref, observed_pairs)
    - 基于 JuMP + Ipopt 建模
    - 变量：电压幅值/相角、注入/支路流，或根据实现细节定义
    - 目标/约束：KCL/KVL、功率平衡、参考母线(Vref, θref)、观测匹配（对 observed_pairs 加权残差）
    - 可将 matrix completion 重构的 X 与注入/电压映射结合，形成联合优化
- 线性配电潮流（lindistflow.jl）
  - 更适合大规模与弱网损情况，近似精度与 AC 模型权衡
  - 可用于初始化或快速筛选拓扑

工程建议：
- Stage2_full_test_opt.jl 展示了进一步集成 AC 优化的版本；若数值困难，可从线性模型出发逐步增强。
- Ipopt 参数：jitter、初值、变量尺度都显著影响收敛。

### 5. 结构后验与拓扑识别
- compute_structure_posteriot.jl（注意文件名拼写：posteriot）
  - 输入：每个拓扑的 ELBO 或目标值列表 elbo_results，以及先验 prob_list
  - 温度化后验：对数域进行 log-sum-exp 稳定化
  - 输出：各结构的后验概率
- 典型流程：
  1) 遍历候选拓扑集合
  2) 对每个拓扑：构建对应的 branch（开断边）、运行 Stage 2 优化/矩阵补全、得到 ELBO/目标
  3) 结合先验计算后验概率，排序输出最可能拓扑

提示：
- 若 ELBO 未显式返回，可使用加权残差 + 正则项的负值作为代理目标，保持“越大越好”的一致性。
- 温度参数可调节后验的“尖锐度”，在不确定性较高时可增大温度以避免过度自信。

--------------------------------
## 运行指南与关键接口

### A. Stage 1 快速上手（Stage1_test.jl）
- 主要步骤：
  - 读取数据：read_mat()
  - 选择子集：extract_requested_dataset_multibatch(...)
  - 构建数据集：build_complete_multisensor_data(ds)
  - 训练多任务GP：multi_task_gaussian（在 include 的文件中执行）
  - 统一预测：generate_1min_resolution_predictions(result)
  - 输出评估：打印各传感器的 RMSE/MAE/MAPE/R2/覆盖率等

- 可能需要关注：
  - 传感器清单与目标母线必须与实际数据一致
  - 高采样率 PMU 会带来大规模核矩阵，必要时限流或分段

### B. Stage 2 快速上手（Stage2_test.jl）
- 主要步骤：
  - 读取/设定拓扑：read_topology_mat(...) 或 get_topology.jl 生成候选
  - 从 Stage 1 结果生成预测：daily_predictions = generate_daily_predictions(result, ...)
    - 若未提供，可改用 implement_data.jl 中的 generate_1min_resolution_predictions
  - 构建观测：build_observed_matrix_Z(daily_predictions; monitor_buses=Set([8,12]))
  - 构建噪声精度：build_noise_precision_beta(daily_predictions)
  - SVD 初始化：对 Z 取 r 阶，得到 A_mean, B_mean
  - 变分/优化循环：更新 A/B/Σa/Σb/γ，或与潮流优化（AC/LD）交替迭代
  - 输出：电压、注入、支路潮流估计；残差与收敛历史

- Stage2_full_test_opt.jl 提升：
  - 增强版参数：更稳健的 r 选择、正则、Ipopt 调优
  - 与 AC 优化更紧耦合

--------------------------------
## 核心原理综述

- 多任务高斯过程（ICM）
  - 将不同传感器/母线/物理量视为不同“任务”
  - 跨任务相关性由低秩矩阵 B = L L' 表示；时间相关由共享核 k_time 与任务本地核 k_local_s 表示
  - 好处：利用异构数据的互补性，在缺测位置进行时空插值并量化不确定性

- β 加权观测矩阵与概率矩阵补全
  - 来自 Stage 1 的预测标准差 σ 反映观测可信度，β = 1/σ^2
  - 在矩阵补全中，β 越大表示该观测更“硬”，反之更“软”
  - 低秩假设兼顾全球相关性，通过变分法对潜在因子后验进行逐行/逐列更新

- 物理约束的引入
  - 纯数据驱动可能导致物理不一致；引入 KCL/KVL 与线路功率约束使解物理可行
  - 可采用两阶段或联合优化，联合时需要精心选择权重与数值稳定策略

- 拓扑识别
  - 将拓扑作为“结构变量”，对每个候选计算证据（ELBO/似然/目标），结合先验得到后验概率
  - 温度参数用于控制后验的“软硬度”

--------------------------------
## 常见问题与调参建议

- 核矩阵数值不稳定
  - 增加 jitter；对时间做标准化；减少一次性训练点规模
- Ipopt 不收敛或震荡
  - 调整初值（用线性潮流结果初始化）；缩放变量；适当放宽/加权观测约束
- β 的设置过于激进
  - 对 σ 很小的点可设置 β 上限避免单点“锁死”；对缺测点 β=0
- 低秩 r 的选择
  - 从 3~5 起步，过大易过拟合且数值不稳，可用验证集选择
- 拓扑后验过于平坦或过于尖锐
  - 调整温度；增加数据量或改善观测覆盖；改进先验

--------------------------------
## 扩展与集成

- 相关性矩阵可引入结构先验（例如地理邻接），对 L_params 加正则
- 引入分层贝叶斯，将 β 的缩放/分组噪声作为超参数学习
- 大规模场景采用近似 GP（如诱导点）与分布式优化
- 与事件检测结合：在时间维度上做拓扑变化的在线识别

--------------------------------
## 最小可运行伪代码参考

- Stage 1（概念性示意）
````markdown
# 加载与抽取
batches = read_mat()
ds = extract_requested_dataset_multibatch(batches)
data = build_complete_multisensor_data(ds)

# 训练多任务GP（内部完成标准化、核构造与优化）
result = train_multitask_gp(data)  # 由 multi_task_gaussian 相关流程给出

# 统一到 1 分钟
daily_predictions = generate_1min_resolution_predictions(result)
save("daily_predictions.jld2", daily_predictions)
````

- Stage 2（概念性示意）
````markdown
# 加载拓扑/生成候选
branch = read_topology_mat(".../topology.mat")
candidates, priors = generate_branch_list_with_prior(branch; ...)

best_score = -Inf
best_topology = nothing

for topo in candidates
  branch_t = apply_topology(branch, topo)
  Z, pairs, obsmeta = build_observed_matrix_Z(daily_predictions; monitor_buses=Set([8,12]))
  β = build_noise_precision_beta(daily_predictions)

  # SVD 初始化
  A,B = svd_init(Z, r=5)

  # 变分/优化迭代（可与 AC/LD 潮流约束交替）
  A,B,stats = matrix_completion_with_physics(Z, β, branch_t; ...)

  # 计算结构证据（ELBO/目标）
  score = compute_elbo_or_objective(A,B,stats)
  if score > best_score
    best_score = score
    best_topology = topo
  end
end

post = compute_structure_posterior(elbo_results, priors; temperature=1.0)
println("Best topology:", best_topology, " posterior:", post)
````

--------------------------------
## 文件与功能映射速查

- Stage1_test.jl：Stage 1 入口脚本
- build_complete_multisensor_data.jl：构造多传感器数据对象
- extract_requested_dataset_multibatch.jl：从多批数据中抽取目标传感器
- data_processing.jl：归一化工具
- multi_task_gaussian.jl：ICM 多任务 GP 核心
- gaussian_prediction.jl：预测与反归一化
- implement_data.jl：生成 1 分钟统一预测与质量评估

- Stage2_test.jl / Stage2_full_test_opt.jl：Stage 2 入口脚本/增强版
- build_observed_matrix_z.jl：构建观测矩阵与观测位置
- build_noise_precision_beta.jl：构建噪声精度矩阵
- matrix_completion.jl：低秩变分更新核心函数
- power_flow_optimal.jl：AC 潮流优化（JuMP + Ipopt）
- lindistflow.jl：线性潮流近似
- get_topology.jl：候选拓扑与先验构造
- compute_structure_posteriot.jl：结构后验计算
- read_mat.jl / generate_series_data.jl：数据 IO 与样本生成

--------------------------------
## 结语

本手册系统呈现了在低可观测条件下，将“数据同化的不确定性建模（Stage 1）”与“物理约束下的估算与结构推断（Stage 2）”无缝衔接的开发流程。建议先以少量传感器与较小候选拓扑集做端到端跑通，再逐步扩展到全量与更复杂的物理约束，并根据数值表现调节 β、低秩维度 r 与优化超参数。若需要，我可以进一步根据你的数据格式，生成可直接运行的最小化示例脚本。

## 创新点
- 将多任务高斯过程和贝叶斯矩阵填充框架扩充到交直流混合配电系统
- 针对光伏发电设备和储能设备，修改核函数为ICM/LMC
- 选取80%的传感器数据作为训练集，20%的传感器数据作为测试集，实现了拓扑组合的精准识别。

## 思考
点估计方法已经可以实现矩阵填充和补齐，为什么需要贝叶斯的框架来辅助学习？

通过层级先验和γ的自适应稀疏化，模型会让多余的秩成分自动“关掉”（大γ→对应列收缩为0），避免手动指定秩或强核范数的过/欠约束。
在低可观测+高噪声环境，这种自动模型选择可显著提升稳健性与收敛速度。
整个流程是“Stage 1概率输出→Stage 2概率加权推断→（可选）到点化输出”。哪怕最终报告点值，过程中的概率信息帮助提高点估计质量与鲁棒性。